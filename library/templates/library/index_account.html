{% extends 'dashboard/base.html' %}

{% block content %}

<div class="container">
    
    <label for="book_name">Search Book:</label>
    <input type="text" id="book_name" required autofocus placeholder="book name">    
    <button type="button" class="btn btn-primary" onclick="search_book()">Search</button>
    
    <button type="button" class="btn btn-danger" onclick="opencamera()">Scan </button>
    <br>
    
    {% if user.is_librarian == True %}
    <a href="/library/book/register"><button type="button" class="btn btn-primary">Register New Books</button></a>
    {% endif %}
    <button type="button" class="btn btn-primary" id='explore_button' onclick="show_explore_table()">Explore Books</button>
    <div id="search_table" class="table-responsive">
        <hr>
        <div class="card shadow">
            <div class="card-header border-0" id="insert_book_name">
            </div>
            <div class="table-responsive">
                <table class="table align-items-center table-flush table-hover">
                    <tr>
                    <th scope="col">Assigned To</th>
                    <th scope="col">Due Date</th>
                    </tr>
                <tbody id="search_results">
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
        <div id="order_table" class="table-responsive">
                <hr>
            <div class="card shadow">
                <div class="card-header border-0">
                    <h3 class="mb-0">Registered Book in Semester :  <select id = "select_sem" onchange="getRegisteredBooks(this.value)">
    
                    </select> </h3>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush table-hover">
                        <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Author</th>
                        <th scope="col">Registered Units</th>
                        <th scope="col">Avaible Units</th>
                        <th scope="col">Borrowed Units</th>
                        </tr>
                    <tbody id="order_results">
                    </tbody>
                </div>
            </div>
        </div>
        </div>
        <div id="myModal" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <div class="qrscanner flip" id="scanner">
                  </div>    
                </div>
              </div>
              <div class="modal" id="scanned_output">
                <div class="modal-content">
                      <span class="cross">&times;</span>
                      <div id = "output">
  
                      </div>
                  </div>
                </div>
              </div>     
        


<script>
    $(document).ready(); { 
        $('#search_table').hide();
        $('#explore_button').hide();
        getSemester();

    };

    function show_explore_table(){
        location.reload();
    }


    function getSelectedBook(id){
        var xhttp = new XMLHttpRequest();
        var book_info = {
            'search_type':'id',
            'id': id,
        };
        $.ajax ({
            type: 'POST',
            url: 'search',
            data: JSON.stringify(book_info),
            success: function(data){
                outputData(data);        
        }
        }); 

        function outputData(data){
            y = data['uuid'].length;
            $("tr").remove(".table-row");
            $('#book_name_show').remove();
            $('#insert_book_name').append(
                '<h2 class="mb-0" id="book_name_show"><u><b>Book Name : '+$("#book_name").val()+'</u></h2>');
            var null_assigned;
            var null_due_date;
            var table_property;
            while (y) {
                y = y -1;
                if(data['is_assigned'][y]){
                    null_assigned = data['assigned_to'][y]
                }
                else {
                    null_assigned = 'Avaible!'
                    $('#assign').show();
                }
                if (data['is_overdue'][y]) {
                    table_property = 'table-danger'
                }
                else { 
                    if (data['is_assigned'][y]){
                        table_property = 'Success'
                    }
                }
                $("#search_results").append(
                    '<tr data-href="'+data['uuid'][y]+'" class="table-row"><td class = "'+table_property+'">'+null_assigned+'</td><td>'+data['due_date'][y]+'</td></tr>'
                )
            }
            $(".table-row").click(function() {
            window.document.location = $(this).data("href");
            });
            $('#order_table').hide();   
            $("#search_table").show();
            
        $('#explore_button').show();
        } 
}    

    function getSemester(){
        var xhttp = new XMLHttpRequest();
        info = {
            'request': "get_semester",
        }
        $.ajax ({
            type: 'POST',
            url: 'get/sem',
            data: JSON.stringify(info),
            success: function(data){
                outputData(data);        
        },
        error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
            }
        });
        function outputData(data){
            y = y = data['semester'].length;
            while (y) {
            y = y -1;
            $("#select_sem").append(
                '<option value = '+data['semester'][y]+'>'+data['semester'][y]+'</option>'
            )
        }
        }
    }

    function getRegisteredBooks(x) {
        var xhttp = new XMLHttpRequest();
        var book_info = {
            'semester': x,
        };
        $.ajax ({
            type: 'POST',
            url: 'get/book',
            data: JSON.stringify(book_info),
            success: function(data){
                outputData(data);        
        },
        error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
            }
        });
        
        function outputData(data){
        y = data['book_name'].length;
        $("tr").remove(".table-row");
        while (y) {
            y = y -1;
            $("#order_results").append(
                '<tr data-href="'+data['id'][y]+'" class="table-row"><td>'+data['book_name'][y] +'</td><td>'+data['author'][y] +'</td><td>'+data['registered_units'][y] +'</td><td>'+data['avaible_units'][y] +'</td><td>'+data['borrowed_units'][y] +'</td></tr>'
            )
        }
        $(".table-row").click(function() {
        x = $(this).data("href");
        getSelectedBook(x);
        });
        $("#search_table").hide();
        $('#order_table').show();        
        $('#explore_button').hide();
    } 

    }

    function search_book(){
    var xhttp = new XMLHttpRequest();
    var book_name = $('#book_name').val();
    var book_info = {
        'search_type':'name',
        'book_name': book_name,
    };
    $.ajax ({
        type: 'POST',
        url: 'search',
        data: JSON.stringify(book_info),
        success: function(data){
            outputData(data);        
    }
    }); 

    function outputData(data){
        y = data['uuid'].length;
        $("tr").remove(".table-row");
        $('#book_name_show').remove();
        $('#insert_book_name').append(
            '<h2 class="mb-0" id="book_name_show"><u><b>Book Name : '+$("#book_name").val()+'</u></h2>');
        var null_assigned;
        var null_due_date;
        var table_property;
        while (y) {
            y = y -1;
            if(data['is_assigned'][y]){
                null_assigned = data['assigned_to'][y]
            }
            else {
                null_assigned = 'Avaible!'
                $('#assign').show();
            }
            if (data['is_overdue'][y]) {
                table_property = 'table-danger'
            }
            else { 
                if (data['is_assigned'][y]){
                    table_property = 'Success'
                }
            }
            $("#search_results").append(
                '<tr data-href="'+data['uuid'][y]+'" class="table-row"><td class = "'+table_property+'">'+null_assigned+'</td><td>'+data['due_date'][y]+'</td></tr>'
            )
        }
        $(".table-row").click(function() {
        window.document.location = $(this).data("href");
        });
        $('#order_table').hide();   
        $("#search_table").show();
        $('#explore_button').show();
    } 
}



// Get the modal
var modal = document.getElementById('myModal');
var scanned_output = document.getElementById('scanned_output');

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];
var span2 = document.getElementsByClassName("cross")[0];

    
// When the user clicks the button, open the modal 
function opencamera(){
    modal.style.display = "block";
    oncall();
}

// When the user clicks on <span> (x), close the modal
                
//this function will be called when JsQRScanner is ready to use

// function JsQRScannerReady()
// {
    //create a new scanner passing to it a callback function that will be invoked when
    //the scanner succesfully scan a QR code
         
// }

function oncall(staus){
    var jbScanner = new JsQRScanner(onQRCodeScanned);
    //reduce the size of analyzed image to increase performance on mobile devices
    jbScanner.setSnapImageMaxSize(300);
    var scannerParentElement = document.getElementById("scanner");
    if(scannerParentElement)
    {
    //append the jbScanner to an existing DOM element
        jbScanner.appendTo(scannerParentElement);
    }   
    span.onclick = function() {
        modal.style.display = "none";
        jbScanner.stopScanning();
        jbScanner.removeFrom(scannerParentElement);
    }
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            jbScanner.stopScanning();
            jbScanner.removeFrom(scannerParentElement);
        }
        if (event.target == scanned_output){
            scanned_output.style.display = "none";
        }
    }
    function onQRCodeScanned(scannedText)
    {
        jbScanner.stopScanning();
        jbScanner.removeFrom(scannerParentElement);
        modal.style.display = "none";
        processQrCode(scannedText) 
  
    }
}
span2.onclick = function() { 
    scanned_output.style.display = "none";
}
                  
function processQrCode(uuid) {
    scanned_output.style.display = "block";
    window.location = "/library/"+uuid; 

}
</script>





<style>
.qrscanner video {
  max-width: 95%;
  max-height: 75%;
}
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    /* position: fixed; */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    /* left: 0;
    top: 0; */
    /* width: 100%; 
    height: 100%; */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 36%;
    justify-content: center;

}

/* The Close Button */
.close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
.flip {
    -webkit-transform: rotateY( 180deg);
    -moz-transform: rotateY( 180deg);
    -o-transform: rotateY( 180deg);
    transform: rotateY( 180deg);
  }    
</style>
{% endblock %}