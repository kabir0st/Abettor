{% extends 'dashboard/base.html' %}

{% block content %}

<div class="container">
    <label for="book_name">Search Book:</label>
    <input type="text" id="book_name" required autofocus placeholder="book name">    
    <button type="button" class="btn btn-primary" onclick="search_book()">Search</button>
    <a href="/library/book/register"><button type="button" class="btn btn-primary">Register New Books</button></a>

    <div id="search_table" class="table-responsive">
        <hr>
        <div class="card shadow">
            <div class="card-header border-0" id="insert_book_name">
            </div>
            <div class="table-responsive">
                <table class="table align-items-center table-flush table-hover">
                    <tr>
                    <th scope="col">Assigned To</th>
                    <th scope="col">Due Date</th>
                    </tr>
                <tbody id="search_results">
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
        <div id="order_table" class="table-responsive">
                <hr>
            <div class="card shadow">
                <div class="card-header border-0">
                    <h3 class="mb-0">Registered Book in Semester :  <select id = "select_sem" onchange="getRegisteredBooks(this.value)">
                        <option value=1 selected="selected">First</option>
                        <option value=2>Second</option>
                        <option value=3>Third</option>
                        <option value=4>Fourth</option>
                        <option value=5>Fifth</option>
                        <option value=6>Sixth</option>
                        <option value=7>Seventh</option>
                        <option value=8>Eighth</option>
                    </select> </h3>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush table-hover">
                        <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Author</th>
                        <th scope="col">Units Registered</th>
                        <th scope="col">Avaible Units</th>
                        </tr>
                    <tbody id="order_results">
                    </tbody>
                </div>
            </div>
        </div>
        </div>
        

<script>
    $(document).ready(); { 
        $('#search_table').hide();
        getRegisteredBooks(1)
    };

    function getRegisteredBooks(x) {
        var xhttp = new XMLHttpRequest();
        var book_name = $('#book_name').val();
        var book_info = {
            'semester': x,
        };
        $.ajax ({
            type: 'POST',
            url: 'book/get',
            data: JSON.stringify(book_info),
            success: function(data){
                outputData(data);        
        },
        error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
            }
        });
        
        function outputData(data){
            console.log(data);
        }

    }

    function search_book(){
    var xhttp = new XMLHttpRequest();
    var book_name = $('#book_name').val();
    var book_info = {
        'book_name': book_name,
    };
    $.ajax ({
        type: 'POST',
        url: 'search',
        data: JSON.stringify(book_info),
        success: function(data){
            outputData(data);        
    }
    }); 

    function outputData(data){
        y = data['uuid'].length;
        $("tr").remove(".table-row");
        $('#book_name_show').remove();
        $('#insert_book_name').append(
            '<h2 class="mb-0" id="book_name_show"><u><b>Book Name : '+$("#book_name").val()+'</u></h2>');
        var null_assigned;
        var null_due_date;
        var table_property;
        while (y) {
            y = y -1;
            if(data['is_assigned'][y]){
                null_assigned = data['assigned_to'][y]
            }
            else {
                null_assigned = 'Avaible!'
                $('#assign').show();
            }
            if (data['is_overdue'][y]) {
                table_property = 'table-danger'
            }
            else { 
                if (data['is_assigned'][y]){
                    table_property = 'Success'
                }
            }
            $("#search_results").append(
                '<tr data-href="'+data['uuid'][y]+'" class="table-row"><td class = "'+table_property+'">'+null_assigned+'</td><td>'+data['due_date'][y]+'</td></tr>'
            )
        }
        $(".table-row").click(function() {
        window.document.location = $(this).data("href");
        });
        $('#order_table').hide();   
        $("#search_table").show();
    } 
}
</script>
    
{% endblock %}