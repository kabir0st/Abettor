{% extends 'dashboard/base.html' %}

{% block content %}
<div class="container">
    <div class="card shadow">
        <div class="card-header border-0">
            <b><u><h1 class="mb-0">Book Name : {{ book_name }}</h1></u></b>
        </div>
        <div class="table-responsive">
            <table class="table align-items-center table-flush table-hover">
                <tr>
                <th scope="col">Author Name :</th>
                <th scope="col">{{ author_name }}</th>
                </tr>
                <tr>
                <th scope="col">Semester :</th>
                <th scope="col">{{ semester }}</th>
                </tr>
                <tr>
                <th scope="col">Assigned To :</th>
                <th scope="col"> {{ assigned_to }} <small> {{ username }} </small></th>
                </tr>
                <tr>
                <th scope="col">Due Date :</th>
                <th scope="col">{{ due_date }}</th>
                </tr>
                    {% if is_assigned is True %}
                <tr>
                    <th><button class="btn btn-danger" onclick="mark_returned()">Mark As Returned</button></th>
                    <th><button class="btn btn-warning" onclick="extend_due_date()">Extend Due Date</button></th>
                </tr>
                    {% else %}
                <tr>
                    <th><input class="form-control" type="text" placeholder="First Name" id="first_name"></th>
                    <th><input class="form-control" type="text" placeholder="Last Name" id ="last_name"></th>
                </tr>
                <tr>
                    <th><button class="btn btn-danger" onclick="search_student()">Search Student</button></th>
                </tr>
                    {% endif %}
                    </table>
                    </div>
        </div>
    </div>



<div class="container">
    
<div id="search_table" class="table-responsive">
        <hr>
    <div class="card shadow">
        <div class="card-header border-0">
            <h3 class="mb-0">Assign {{ book_name }} To : </h3>
        </div>
        <div class="table-responsive">
            <table class="table align-items-center table-flush table-hover">
                <tr>
                <th scope="col">Name</th>
                <th scope="col">Current Semester</th>
                <th scope="col">Username</th>
                </tr>
            <tbody id="results">
            </tbody>
        </div>
    </div>
</div>
</div>



<script>
$(document).ready(function(){
    $("#search_table").hide();
})

function search_student(){
        var xhttp = new XMLHttpRequest();
        var first_name = $('#first_name').val();
        var last_name = $('#last_name').val();
        var info = {
            'first_name': first_name,
            'last_name': last_name,
        };
        $.ajax ({
            type: 'POST',
            url: '/payment/search',
            data: JSON.stringify(info),
            success: function(data){
                outputData(data);
            }
        });
    }


    function outputData(data){        
        $("tr").remove(".table-row");
        y = data['username'].length;
        while (y) {
            y = y -1;
            $("#results").append(
                    '<tr class="table-row" data-href="'+data['username'][y]+'"><td>'+data['name'][y]+'</td><td>'+data['semester'][y]+'</td><td>'+data['username'][y]+'</td></tr>'
            )
        }
        $(".table-row").click(function() {
        var x = $(this).data("href");
        assign(x);
        });
        $("#search_table").show();
    }
    
    function assign(username){ 
        uuid = '{{ uuid }}'
        info = {
            'username':username,
            'uuid':uuid,
            }
        $.ajax ({
            type: 'POST',
            url: '/library/book/assign',
            data: JSON.stringify(info),
            success: function(data){
                swal("Book Assigned To The Selected User of username: "+data['username']+" ! ", {
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            },
            error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            }            
        });
        }

    function mark_returned() {
        info = {
            'username': '{{ username }}',
            'uuid': '{{ uuid }}',
        }
        $.ajax ({
            type: 'POST',
            url: '/library/book/return',
            data: JSON.stringify(info),
            success: function(data){
                swal("This Book is marked as returned.", {
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            },
            error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            }   
    })
    }
     
    function extend_due_date() {
        info = {
            'username': '{{ username }}',
            'uuid': '{{ uuid }}',
        }
        $.ajax ({
            type: 'POST',
            url: '/library/book/extend',
            data: JSON.stringify(info),
            success: function(data){
                swal("Due Date Exteneded By 2 Weeks", {
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            },
            error: function(data){
                swal("An unexpected error occured, Please report to the devs.", {
                    dangerMode: true,
                    buttons: {
                        confirm: true,
                    },
                    })
                    .then(() => {
                        location.reload();                        
                    })
            }   
    })
    }
</script>
{% endblock %}